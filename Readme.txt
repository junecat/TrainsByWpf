Уважаемые господа, 
спасибо Вам за интересное тестовое задание.

я прошу прощения, что я не написал ответ сразу: извините, у меня сейчас столько работы, что я просто к вечеру валюсь с ног.

Со второй попытки я решил Вашу задау, кажется, как надо.

Единственные два замечания: я добавил один поезд в расписание с самого начала - просто чтобы открывалась не пустая таблица, и в 5 раз ускорил работу - просто, чтобы быстрее смотреть на бегущие строчки.
Думаю, для тестового задания - это допустимые отклонения от исходной задачи.

Еще раз спасибо за корректное и уважительное собеседование, и за интересную задачу.

С уважением,

Константин Давыдов.
